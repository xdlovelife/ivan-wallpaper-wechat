"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.WxCalendar=exports.timestamp=exports.fillAnnualSubs=exports.sameAnnualSubs=exports.sameAnnualMarks=exports.sameAnnualMarkStyle=exports.sameSchedules=exports.sameMark=exports.getDateInfo=exports.monthDiff=exports.getWeekDateIdx=exports.findDateIndex=exports.findInWeeks=exports.weekRange=exports.sortWeeks=exports.inMonthDate=exports.offsetDate=exports.normalDate=exports.isToday=exports.isSameWeek=exports.isSameDate=exports.isLeapYear=exports.getMonthDays=exports.formDateByStrKey=exports.mergeAnnualMarks=exports.mergeAnnualDateStyle=exports.getScheduleDetail=exports.parseMarkKey=exports.getMarkKey=exports.getAnnualMarkKey=exports.themeStyle=exports.styleStringify=exports.styleParse=void 0;const t=require("../basic/layout"),o=require("../basic/constants"),n=require("../utils/shared"),r=require("../basic/service"),a=require("../plugins/mark"),e=e=>"string"==typeof e?(0,n.strToStyle)(e):e||{},s=(exports.styleParse=e,t=>Object.keys(t).sort().map(e=>`${(0,n.camelToSnake)(e,"-")}:${t[e]};`).join("")),l=(exports.styleStringify=s,e=>(null==e?void 0:e[t.Layout.theme])||(null==e?void 0:e.light)),i=(exports.themeStyle=l,e=>e.month+"_"+e.day),y=(exports.getAnnualMarkKey=i,(e,t)=>(t?`[[${t}]]`:"")+e),u=(exports.getMarkKey=y,/^\[\[(.*?)\]\]/),h=e=>{var t;if(e)return t=(null==(t=e.match(u))?void 0:t[1])||void 0,{id:e.replace(u,""),plugin:t}},p=(exports.parseMarkKey=h,(e,t,r)=>{var a=(0,exports.parseMarkKey)(t.key),r=null!=a&&a.plugin?r.getPlugin(a.plugin):void 0;return{text:t.text,color:t.color,bgColor:t.bgColor,plugin:null==a?void 0:a.plugin,info:null==(t=null==r?void 0:r.PLUGIN_TRACK_SCHEDULE)?void 0:t.call(r,e,null==a?void 0:a.id)}}),x=(exports.getScheduleDetail=p,(r,a)=>{return r&&a?[...new Set([...Object.keys(r),...Object.keys(a)])].reduce((e,t)=>(e[t]=Object.assign(Object.assign({},r[t]),a[t]),e),{}):r||a?Object.assign(Object.assign({},r),a):void 0}),m=(exports.mergeAnnualDateStyle=x,(e,t)=>{if(t){var r,a;e=e||new Map;for([r,a]of t.entries()){var n=e.get(r)||{};a.rwtype&&(n.rwtype=a.rwtype),a.sub&&(n.sub=a.sub),a.style&&(n.style=(0,exports.mergeAnnualDateStyle)(n.style,a.style)),e.set(r,n)}}return e}),d=(exports.mergeAnnualMarks=m,e=>{var[e,t,r]=e.split("_");return{year:+e,month:+t,day:+r}}),g=(exports.formDateByStrKey=d,e=>new Date(e.year,e.month,0).getDate()),c=(exports.getMonthDays=g,e=>e%100!=0&&e%4==0||e%400==0),f=(exports.isLeapYear=c,(e,t)=>{var{year:e,month:r,day:a,week:n}=b(e);return{key:e+`_${r}_`+a,year:e,month:r,day:a,week:n,kind:t,today:(0,exports.isToday)({year:e,month:r,day:a}),style:"",mark:null,corner:null,schedules:[]}}),k=(e,t=0)=>{const{year:r,month:a,week:n}=e;return Array.from({length:Math.abs(n+7-t)%7},(e,t)=>f({year:r,month:a,day:-t},"last")).reverse()},D=(e,t=0)=>{const{year:r,month:a,day:n,week:o}=e;return Array.from({length:6-Math.abs(o+7-t)%7},(e,t)=>{return f({year:r,month:a,day:n+t+1},"next")})},S=r=>Array.from({length:(0,exports.getMonthDays)(r)},(e,t)=>f({year:r.year,month:r.month,day:t+1},"current")),v=(t,a)=>Array.from({length:a.length/7},(e,r)=>({key:`${t.year}_${t.month}_`+r,days:Array.from({length:7},(e,t)=>a[7*r+t])})),M=(e,t)=>e.year===t.year&&e.month===t.month&&e.day===t.day,_=(exports.isSameDate=M,(e,t,r=0)=>{e=(0,exports.weekRange)(e,r),r=+new Date(t.year,t.month-1,t.day);return r>=+e[0]&&r<=+e[1]}),w=(exports.isSameWeek=_,e=>(0,exports.isSameDate)(e,j.today||e));function b(e,t,r){var a;return e?{year:r=(t=(0,n.isString)(e)?new Date(e):(0,n.isNumber)(e)?void 0!==t&&void 0!==r?new Date(e,t-1,r):new Date(e):(0,n.isDate)(e)?e:new Date(e.year,e.month-1,e.day)).getFullYear(),month:e=t.getMonth()+1,day:a=t.getDate(),week:t.getDay(),today:(0,exports.isToday)({year:r,month:e,day:a})}:null}exports.isToday=w,exports.normalDate=b;const A=(e,t)=>b(e.year,e.month,e.day+t),I=(exports.offsetDate=A,(e,t,r)=>b({year:e,month:t,day:Math.min(r,(0,exports.getMonthDays)({year:e,month:t}))})),P=(exports.inMonthDate=I,e=>o.WEEKS.slice(e)+o.WEEKS.slice(0,e)),K=(exports.sortWeeks=P,(e,t=0)=>{var{year:e,month:r,day:a,week:n}=b(e),e=new Date(e,r-1,a-(n+7-t)%7),r=new Date(e.getFullYear(),e.getMonth(),e.getDate()+6);return[e,r]}),L=(exports.weekRange=K,(e,t)=>e.flatMap(e=>e.days).find(t)),W=(exports.findInWeeks=L,(e,t)=>e.flatMap(e=>e.days).findIndex(t)),N=(exports.findDateIndex=W,(r,t)=>{let a=-1,n=-1;for(let e=0;e<t.length;e++){var o=t[e].days.findIndex(({month:e,day:t})=>e===r.month&&t===r.day);if(0<=o){a=e,n=o;break}}return{wdx:a,ddx:n}}),U=(exports.getWeekDateIdx=N,(e,t=0)=>{var{year:e,month:r,day:a}=e,r=new Date(e,r-1,a),a=new Date(e,0,4);return a.setDate(a.getDate()-(a.getDay()+7-t)%7),r<a?U({year:e,month:1,day:0},t):(e=Math.floor((+r-+a)/864e5)+1,Math.ceil(e/7))}),E=(e,t)=>{return 12*(t.year-e.year)+t.month-e.month},G=(exports.monthDiff=E,(e,t=0)=>{var r=(0,exports.getMonthDays)(e),{year:e,month:a}=e,n=new Date(e,a-1,1).getDay(),n=Math.abs(n+7-t)%7;return{key:`y_${e}_m_`+a,year:e,month:a,weeks:Math.ceil((r+n)/7),days:r+n,start:n}}),C=(e,t,r=!1)=>{var a=new Date(j.today.year,j.today.month-1,j.today.day),n=new Date(e.year,e.month-1,e.day),n=Math.floor((n.getTime()-a.getTime())/864e5),a=(0,exports.isToday)(e)?"周"+o.WEEKS[e.week]:Math.abs(n)+"天"+(n<0?"前":"后");return r?`第${U(e,t)}周 `+a:a},O=(exports.getDateInfo=C,(e,t)=>{if(e&&t){if(e.text!==t.text&&(e.text||t.text))return!1;if(e.color!==t.color&&(e.color||t.color))return!1}else if(!e&&t||e&&!t)return!1;return!0}),T=(exports.sameMark=O,(t,r)=>{if(t&&r){if(t.length!==r.length)return!1;let e=0;for(;e<t.length;){var a=t[e],n=r[e];if(a.key!==n.key&&(a.key||n.key))return!1;if(a.text!==n.text&&(a.text||n.text))return!1;if(a.color!==n.color&&(a.color||n.color))return!1;if(a.bgColor!==n.bgColor&&(a.bgColor||n.bgColor))return!1;e++}}else{if(!t&&r)return!r.length;if(t&&!r)return!t.length}return!0}),Y=(exports.sameSchedules=T,(e,t)=>{if(!e&&!t)return!0;if(e&&t){var r=Object.keys(e),a=Object.keys(t);if(r.length!==a.length)return!1;a=new Set([...r,...a]);if(a.size!==r.length)return!1;for(const s of a){var n=e[s],o=t[s];if(n.light!==o.light||n.dark!==o.dark)return!1}return!0}return!1}),$=(exports.sameAnnualMarkStyle=Y,(e,t)=>{if(e.size||null!=t&&t.size){if(e.size!==(null==t?void 0:t.size))return!1;var r,a;for([r,a]of e.entries()){var n=t.get(r);if(!n||n.rwtype!==a.sub||n.sub!==a.sub||!(0,exports.sameAnnualMarkStyle)(a.style,n.style))return!1}}return!0}),q=(exports.sameAnnualMarks=$,(t,r)=>{if(null!=t&&t.length||null!=r&&r.length){if((null==t?void 0:t.length)!==(null==r?void 0:r.length))return!1;for(let e=0;e<t.length;e++){var a=t[e],n=r[e];if(a.color!==n.color||a.text!==n.text)return!1}}return!0}),z=(exports.sameAnnualSubs=q,(r,a,e)=>null==e?void 0:e.map((e,t)=>(e.key=e.key||`AS_${r}_${a}_`+t,e))),R=(exports.fillAnnualSubs=z,e=>+new Date(e.year,e.month-1,e.day,0,0,0,0));exports.timestamp=R;class j{constructor(e,t){t=[...t,...j._PLUGINS_,a.MarkPlugin].map(e=>e.construct?e:{construct:e});this.service=new r.PluginService(e,t)}createMonth(e,t=0){var{year:e,month:r}=b({year:e.year,month:e.month,day:1}),a=S({year:e,month:r}),n=a.length,o=k(a[0],t),t=D(a[n-1],t),o=[...o,...a,...t],a={key:e+"_"+r,year:e,month:r,weeks:v({year:e,month:r},o),count:n};return this.service.catchMonth(a),a}createYear(r,a=0){var e=Array.from({length:12},(e,t)=>G({year:r,month:t+1},a)),e={key:"Y_"+r,year:r,subinfo:[],months:e,marks:new Map};return this.service.catchYear(e),e}static use(t,e){var r=this._PLUGINS_.findIndex(e=>e.construct.KEY===t.KEY);return 0<=r&&this._PLUGINS_.splice(r,1),this._PLUGINS_.push({construct:t,options:e}),this}static clearPlugin(t){(0,n.isString)(t)?this._PLUGINS_=this._PLUGINS_.filter(e=>e.construct.KEY===t):(0,n.isFunction)(t)?this._PLUGINS_=this._PLUGINS_.filter(e=>!t(e)):this._PLUGINS_=[]}}(exports.WxCalendar=j).today=b(new Date),j._PLUGINS_=[];