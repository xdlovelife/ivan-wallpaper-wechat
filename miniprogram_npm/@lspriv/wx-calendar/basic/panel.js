"use strict";var t=this&&this.__awaiter||function(e,s,c,o){return new(c=c||Promise)(function(a,t){function n(e){try{i(o.next(e))}catch(e){t(e)}}function r(e){try{i(o.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?a(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(n,r)}i((o=o.apply(e,s||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PanelTool=void 0;const e=require("../interface/component"),i=require("./layout"),y=require("./constants"),k=require("./tools"),s=require("../utils/calc"),r=require("../utils/shared"),v=require("../interface/calendar");class a extends e.CalendarHandler{createMonthPanels(n){const r=this._instance_.data.current,{year:i,month:s,day:c}=n;return Array.from({length:y.CALENDAR_PANELS},(e,t)=>{var a=(0,v.inMonthDate)(i,s+t-r,c);return this.createPanel(a,t,this.calcWeekOffset((0,v.offsetDate)(n,7*(t-r))))})}createWeekPanels(t){var a=this._instance_.data.current,n=[];for(let e=0;e<y.CALENDAR_PANELS;e++){var r=(0,v.offsetDate)(t,7*(e-a));n.push(this.createPanel(r,e,this.calcWeekOffset(r),n))}return n}createYearPanels(a){const n=this._instance_.data.current;return Array.from({length:y.CALENDAR_PANELS},(e,t)=>this.createYearPanel(a.year+t-n,t))}refreshPanels(t){var{current:a,checked:n}=t,r=this._instance_._view_&y.View.week,i=!this.skyline&&!!r,s=[];for(let e=0;e<y.CALENDAR_PANELS;e++){var c=this._instance_.data.panels[e],o=(0,k.circularDiff)(e,a),h=(0,v.offsetDate)(n,7*o),[l,d]=this.calcWeekOffset(h),h=r?h:(0,v.inMonthDate)(n.year,n.month+o,n.day);c.year!==h.year||c.month!==h.month?(o=this.createPanel(h,e,[l,d],s),t[`panels[${e}]`]=o,s.push(o),i&&(t.offsetChange=!0)):c.offset!==d&&(t[`panels[${e}].offset`]=d,t[`panels[${e}].wdx`]=l,i)&&(t.offsetChange=!0)}}refresh(i,s,c,o){return t(this,void 0,void 0,function*(){var e,t,a=this._instance_,n=a._view_&y.View.week,r=(a.data.current+i)%y.CALENDAR_PANELS,r=(c=null!=c?c:0<=r?r:r+y.CALENDAR_PANELS,s||({year:r,month:e,day:t}=a.data.checked,s=n?(0,v.normalDate)(r,e,t+7*i):(0,v.inMonthDate)(r,e+i,t)),{current:c,info:(0,v.getDateInfo)(s,a.data.weekstart,n),checked:s});this.refreshPanels(r),a._pointer_.update(r,o),a.setData(r),yield this.update()})}refreshView(s){return t(this,void 0,void 0,function*(){var e=this._instance_,{current:t,checked:a,weekstart:n}=e.data,r=(e._view_=s,(0,k.flagView)(s)),i=s&y.View.week,r={currView:r,info:(0,v.getDateInfo)(a,n,i),checked:a,current:t};this.refreshPanels(r),e.setData(r),yield this.update()})}refreshOffsets(t,e,a){var n,r,i,s,c=this._instance_,o=Array.isArray(e),h=null!=(h=t.current)?h:c.data.current,l=null!=(l=t.checked)?l:c.data.checked,d=!o&&null!=(n=e)?n:h,u=!o&&a||l,f=o?e:[],_=!this.skyline&&!!(c._view_&y.View.week);for(let e=0;e<y.CALENDAR_PANELS;e++)f.includes(e)||(r=this._instance_.data.panels[e],i=(0,k.circularDiff)(e,d),[i,s]=this.calcWeekOffset((0,v.offsetDate)(u,7*i)),r.offset!==s&&(t[`panels[${e}].offset`]=s,t[`panels[${e}].wdx`]=i,_)&&(t.offsetChange=!0))}refreshAnnualPanels(o,h,l=!1){var d;return t(this,void 0,void 0,function*(){var t=this._instance_,e=null!=(d=t.data.annualCurr)?d:(0,k.middle)(y.CALENDAR_PANELS),a=t.data.years[e].year+o,e=(e+o)%y.CALENDAR_PANELS,n=null!=h?h:0<=e?e:e+y.CALENDAR_PANELS,r={annualCurr:n},i=(l&&(r.annualDuration=0),[]);for(let e=0;e<y.CALENDAR_PANELS;e++){var s=t.data.years[e],c=a+(0,k.circularDiff)(e,n);s.year!==c&&(s=this.createYearPanel(c,e),r[`years[${e}]`]={key:s.key,year:s.year,subinfo:s.subinfo},t._years_.splice(e,1,{year:s.year,months:s.months,marks:s.marks}),i.push(e))}t.setData(r),yield(0,k.nextTick)(),t._printer_.update(i)})}createPanel(t,e,a,n=[]){var r=this._instance_,e="panel_"+e,[a,i]=a,n=[...r.data.panels,...n].find(e=>e.year===t.year&&e.month===t.month);if(n){const{year:c,month:s,weeks:o,count:h}=n;return{year:c,month:s,weeks:o,count:h,key:e,offset:i,wdx:a}}n=r.data.weekstart;const s=r._calendar_.createMonth({year:t.year,month:t.month},n);return Object.assign(Object.assign({},s),{key:e,offset:i,wdx:a})}createYearPanel(e,t){var a=this._instance_,n=a.data.weekstart,a=a._calendar_.createYear(e,n);return Object.assign(Object.assign({},a),{key:"y_"+t})}findWeekPanelIdx(e){var{checked:t,current:a,weekstart:n}=this._instance_.data,r=new Date(e.year,e.month-1,e.day);for(let e=0;e<y.CALENDAR_PANELS;e++){var i=(0,k.circularDiff)(e,a),[i,s]=(0,v.weekRange)((0,v.offsetDate)(t,7*i),n);if(i<=r&&r<=s)return e}return-1}toDate(e){return t(this,void 0,void 0,function*(){const i=this._instance_,s=(0,v.normalDate)(e);return i._calendar_.service.interceptEvent("manual",s,()=>t(this,void 0,void 0,function*(){var e,{current:t,panels:a,checked:n,weekstart:r}=i.data;(0,v.isSameDate)(s,n)||((e=(n=i._view_&y.View.week)?this.findWeekPanelIdx(s):a.findIndex(e=>e.year===s.year&&e.month===s.month))===t?n?(a=(0,v.findInWeeks)(a[e].weeks,e=>(0,v.isSameDate)(e,s)))&&(yield this.toWeekAdjoin(a,!1)):(a={info:(0,v.getDateInfo)(s,r,n),checked:s},this.refreshOffsets(a,t,s),i._pointer_.update(a),i.setData(a),yield this.update()):(yield i._pointer_.resetOffsetY(s),r=i.data.panels[t],n=(0,v.monthDiff)(r,{year:s.year,month:s.month}),yield this.refresh(n,s,0<=e?e:t)),i.trigger("change",{checked:s,source:"manual"}))}))})}toWeekAdjoin(r,i=!0){return t(this,void 0,void 0,function*(){var e=this._instance_,t=e.data.current,a={info:(0,v.getDateInfo)(r,e.data.weekstart,!0),checked:r},n=this.calcWeekOffset(r);a[`panels[${t}]`]=this.createPanel(r,t,n),e._pointer_.update(a,!1,e.data.checked,!0),this.skyline||(a.offsetChange=!0),e.setData(a),yield(0,k.nextTick)(),yield this.update(),e._pointer_.update(void 0,i)})}toAnnualMonth(s,c=!0){var o;return t(this,void 0,void 0,function*(){var e=this._instance_,{checked:t,current:a,panels:n,weekstart:r}=e.data,i=n[a];i.year===s.year&&i.month===s.month&&(e._view_&y.View.month||!c)||(i=(0,v.inMonthDate)(s.year,s.month,t.day),n={current:0<=(n=n.findIndex(e=>e.year===s.year&&e.month===s.month))?n:a,checked:i},!c||e._view_&y.View.month||(a=(0,k.flagView)(y.View.month),n.currView=a,n.info=(0,v.getDateInfo)(i,r,!1),this.skyline?null!=(o=e._dragger_)&&o.toView(y.View.month,!1):n.initView=y.VIEWS.MONTH,e._view_=y.View.month),this.refreshPanels(n),e._pointer_.update(n,!1,void 0,!0),e.setData(n),yield this.update(),(0,v.isSameDate)(i,t))||e.trigger("change",{checked:i,source:"annual"})})}toYear(t){var e=this._instance_,a=null!=(a=e.data.annualCurr)?a:(0,k.middle)(y.CALENDAR_PANELS),n=e.data.years[a];return(0,r.nonNullable)(e.data.annualCurr)&&n.year===t?Promise.resolve():(e=e.data.years.findIndex(e=>e.year===t),n=t-n.year,this.refreshAnnualPanels(n,0<=e?e:a,!this.skyline))}getFullYear(e){return Object.assign(Object.assign({},this._instance_.data.years[e]),this._instance_._years_[e])}update(){return t(this,void 0,void 0,function*(){yield(0,k.nextTick)(),this.skyline&&this._instance_._dragger_.update()})}calcWeekOffset(e){return this.skyline?[0,0]:a.calcPanelOffset(e,this._instance_.data.weekstart)}static calcPanelOffset(e,t){var{year:e,month:a,day:n}=e,r=new Date(e,a-1,1),r=Math.abs(r.getDay()+7-t)%7,t=(0,v.getMonthDays)({year:e,month:a}),e=Math.ceil((r+t)/7),a=Math.ceil((n+r)/7)-1;return[a,(0,s.mul)(a,(0,s.div)(i.Layout.layout.mainHeight,e))]}}exports.PanelTool=a;