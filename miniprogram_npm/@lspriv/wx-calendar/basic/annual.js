"use strict";var t=this&&this.__awaiter||function(t,_,l,r){return new(l=l||Promise)(function(i,e){function a(t){try{n(r.next(t))}catch(t){e(t)}}function s(t){try{n(r.throw(t))}catch(t){e(t)}}function n(t){var e;t.done?i(t.value):((e=t.value)instanceof l?e:new l(function(t){t(e)})).then(a,s)}n((r=r.apply(t,_||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnnualPanelSwitch=void 0;const e=require("../interface/component"),r=require("./tools"),o=require("./constants"),c=require("../utils/shared"),{shared:h,timing:i,Easing:a}=wx.worklet,d="-150vh";class s extends e.CalendarHandler{constructor(t){super(t),this._interactive_callbacks_=[],this._transforming_=!1,this.skyline&&this.initialize()}initialize(){this._style_ids_=new Map,this.bindAnimations()}bindAnimations(){return t(this,void 0,void 0,function*(){const t=h(d),e=h(0),i=h(0),a=h(1);this._top_=t,this._opacity_=e,this._calendar_trans_=i,this._calendar_alpha_=a;var[s,n,_,l]=yield(0,c.promises)([(0,r.applyAnimated)(this._instance_,o.SELECTOR.ANNUAL,()=>{"worklet";return{top:t.value,opacity:e.value}}),(0,r.applyAnimated)(this._instance_,o.SELECTOR.CALENDAR,()=>{"worklet";return{opacity:1-e.value}}),(0,r.applyAnimated)(this._instance_,o.SELECTOR.PANEL_HEADER,()=>{"worklet";return{transform:`translateY(${-i.value}%)`,opacity:a.value}}),(0,r.applyAnimated)(this._instance_,o.SELECTOR.BAR,()=>{"worklet";return{transform:`translateY(${i.value}%)`,opacity:a.value}})]);this._style_ids_.set(o.SELECTOR.ANNUAL,s),this._style_ids_.set(o.SELECTOR.CALENDAR,n),this._style_ids_.set(o.SELECTOR.PANEL_HEADER,_),this._style_ids_.set(o.SELECTOR.BAR,l)})}showCalendar(){var t={duration:280,easing:a.out(a.sin)};this._calendar_trans_.value=i(0,t),this._calendar_alpha_.value=i(1,t)}hiddenCalendar(){this._calendar_trans_.value=200,this._calendar_alpha_.value=0}getCalendarRect(){return t(this,void 0,void 0,function*(){return(yield(0,r.nodeRect)(this._instance_)(o.SELECTOR.CALENDAR))[0]})}switch(a,s){return t(this,void 0,void 0,function*(){var t,e=this._instance_;if(!this._transforming_){this._transforming_=!0;const i=this.skyline;a?(yield e._panel_.toYear(s.year),t=yield this.getCalendarRect(),i?this._top_.value=`-${t.top}px`:e.setData({annualTop:0,annualDuration:300,annualOpacity:1}),yield(0,r.severalTicks)(10),yield e._printer_.open(s,t,()=>{i&&(this._opacity_.value=1)}),i&&this.hiddenCalendar()):(yield e._panel_.toAnnualMonth(s,e.$_gesture.value),yield(0,r.severalTicks)(10),yield e._printer_.close(s),i?this._opacity_.value=0:e.setData({annualOpacity:0}),i&&this.showCalendar(),yield(0,r.nextTick)(),i?this._top_.value=d:e.setData({annualTop:d})),this._transforming_=!1,this.execInteractiveCallbacks()}})}clearSkyline(){var t,e=this._instance_;null!=(t=this._style_ids_)&&t.has(o.SELECTOR.ANNUAL)&&(0,r.clearAnimated)(e,o.SELECTOR.ANNUAL,[this._style_ids_.get(o.SELECTOR.ANNUAL)]),null!=(t=this._style_ids_)&&t.has(o.SELECTOR.CALENDAR)&&(0,r.clearAnimated)(e,o.SELECTOR.CALENDAR,[this._style_ids_.get(o.SELECTOR.CALENDAR)]),null!=(t=this._style_ids_)&&t.has(o.SELECTOR.PANEL_HEADER)&&(0,r.clearAnimated)(e,o.SELECTOR.PANEL_HEADER,[this._style_ids_.get(o.SELECTOR.PANEL_HEADER)]),null!=(t=this._style_ids_)&&t.has(o.SELECTOR.BAR)&&(0,r.clearAnimated)(e,o.SELECTOR.BAR,[this._style_ids_.get(o.SELECTOR.BAR)]),null!=(t=this._style_ids_)&&t.clear(),this._style_ids_=void 0,this._opacity_=void 0,this._top_=void 0,this._calendar_trans_=void 0,this._calendar_alpha_=void 0}execInteractiveCallbacks(){for(;this._interactive_callbacks_.length;){var t=this._interactive_callbacks_.shift();(0,c.isFunction)(t)&&t()}}interaction(){return this._transforming_?new Promise(t=>{this._interactive_callbacks_.push(t)}):Promise.resolve()}}exports.AnnualPanelSwitch=s;